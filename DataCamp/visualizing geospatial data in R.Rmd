---
title: "visualizing geospatial data in R"
author: "DataCamp - Charlotte Wickham"
date: "11/21/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

**What is spatial data?**

- data associated with locations
- location described by coordinates + a coordinate reference system (CRS)
- common CRS: longitude, latitude describes locations on the surface of the Earth

![](_images/300.png)

**Point data**: locations are points, described by a single pair of coordinates

![](_images/301.png)

![](_images/302.png)

**Grabbing a background map**

There are two steps to adding a map to a `ggplot2` plot with `ggmap`:

1. Download a map using `get_map()`
2. Display the map using `ggmap()`

As an example, let's grab a map for New York City:

```
library(ggmap)

nyc <- c(lon = -74.0059, lat = 40.7128)
nyc_map <- get_map(location = nyc, zoom = 10)
```

`get_map()` has a number of arguments that control what kind of map to get, but for now you'll mostly stick with the defaults. The most important argument is the first, `location`, where you can provide a longitude and latitude pair of coordinates where you want the map centered. (We found these for NYC from a quick google search of "coordinates nyc".) The next argument, `zoom`, takes an integer between 3 and 21 and controls how far the mapped is zoomed in. In this exercise, you'll set a third argument, `scale`, equal to 1. This controls the resolution of the downloaded maps and you'll set it lower (the default is 2) to reduce how long it takes for the downloads.

Displaying the map is then as simple as calling `ggmap()` with your downloaded map as the only argument: `ggmap(nyc_map)`

Your turn! We are going to be looking at house sales in Corvallis, but you probably have no idea where that is! Let's find out.

```{r, message = FALSE}
library(pacman)
p_load(ggmap)
corvallis <- c(lon = -123.2620, lat = 44.5646)

# Get map at zoom level 5: map_5
map_5 <- ggmap::get_map(location = corvallis, zoom = 5, scale = 1)

# Plot map at zoom level 5
ggmap(map_5)

# Get map at zoom level 13: corvallis_map
corvallis_map <- get_map(corvallis, zoom = 13, scale = 1)

# Plot map at zoom level 13
ggmap(corvallis_map)
```

**Putting it all together**
You now have a nice map of Corvallis, but how do you put the locations of the house sales on top?

Similar to `ggplot()`, you can add layers of data to a `ggmap()` call (e.g. `+ geom_point()`). It's important to note, however, that `ggmap()` sets the map as the default dataset and also sets the default aesthetic mappings.

This means that if you want to add a layer from something other than the map (e.g. `sales`), you need to explicitly specify both the `mapping` and `data` arguments to the geom.

What does this look like? You've seen how you might make a basic plot of the sales:

```
ggplot(sales, aes(lon, lat)) + 
  geom_point()
```

An equivalent way to specify the same plot is:

```
ggplot() + 
  geom_point(aes(lon, lat), data = sales)
```

Here, we've specified the data and mapping in the call to `geom_point()` rather than `ggplot()`. The benefit of specifying the plot this way is you can swap out `ggplot()` for a call to `ggmap()` and get a map in the background of the plot.

```{r}
sales <- readRDS(file = "_data/01_corv_sales.rds")

# Look at head() of sales
head(sales)

# Swap out call to ggplot() with call to ggmap()
ggmap(corvallis_map) +
  geom_point(aes(lon, lat), data = sales)
```

You just made your first data map!

**Insight through aesthetics**

Adding a map to your plot of sales explains some of the structure in the data: there are no house sales East of the Willamette River or on the Oregon State University campus. This structure is really just a consequence of where houses are in Corvallis; you can't have a house sale where there are no houses!

The value of displaying data spatially really comes when you add other variables to the display through the properties of your geometric objects, like color or size. You already know how to do this with `ggplot2` plots: add additional mappings to the aesthetics of the geom.

Let's see what else you can learn about these houses in Corvallis.

*NOTE: Many exercises in this course will require you to create more than one plot. You can toggle between plots with the arrows at the bottom of the 'Plots' window and zoom in on a plot by clicking the arrows on the tab at the top of the 'Plots' window.*

```{r}
# Map color to year_built
ggmap(corvallis_map) +
  geom_point(aes(lon, lat, color = year_built), data = sales)

# Map size to bedrooms
ggmap(corvallis_map) +
  geom_point(aes(lon, lat, size = bedrooms), data = sales)

# Map color to price / finished_squarefeet
ggmap(corvallis_map) +
  geom_point(aes(lon, lat, color = price/finished_squarefeet), data = sales)
```

The last plot wasn't so successful because one sale had a very high price per squarefoot. This pushed all the other sales into the same color range and made it hard to see any patterns. You could solve that by filtering out the offending sale, or change the way the values are mapped to colors, something we'll talk about in Chapter 3. You might also be wondering why some of the points are gray even though gray isn't in our color scale. The gray points are locations with missing values for the variable we have mapped to color, that is, sales with `NA` for price or `finished_squarefeet`.

**Useful get_map() and ggmap() options**

![](_images/303.png)

![](_images/304.png)

![](_images/305.png)

**Different maps**

The default Google map downloaded by `get_map()` is useful when you need major roads, basic terrain, and places of interest, but visually it can be a little busy. You want your map to add to your data, not distract from it, so it can be useful to have other "quieter" options.

Sometimes you aren't really interested in the roads and places, but more what's on the ground (e.g. grass, trees, desert, or snow), in which case switching to a satellite view might be more useful. You can get Google satellite images by changing the `maptype` argument to `"satellite"`.

You can grab [Stamen Maps](http://maps.stamen.com/) by using `source = "stamen"` in `get_map()`, along with specifying a `maptype` argument. You can see all possible values for the `maptype` argument by looking at `?get_map`, but they correspond closely to the "flavors" described on the Stamen Maps site. I like the `"toner"` variations, as they are greyscale and a bit simpler than the Google map.

Let's try some other maps for your plot of house sales.

```{r, message = FALSE}
corvallis <- c(lon = -123.2620, lat = 44.5646)

# Add a maptype argument to get a satellite map
corvallis_map_sat <- get_map(corvallis, zoom = 13, maptype = "satellite")


# Edit to display satellite map
ggmap(corvallis_map_sat) +
  geom_point(aes(lon, lat, color = year_built), data = sales)

# Add source and maptype to get toner map from Stamen Maps
corvallis_map_bw <- get_map(corvallis, zoom = 13, source = "stamen", maptype = "toner")

# Edit to display toner map
ggmap(corvallis_map_bw) +
  geom_point(aes(lon, lat, color = year_built), data = sales)
```

Great work! Don't mind any warnings in the console for now.

**Leveraging ggplot2's strengths**

You've seen you can add layers to a `ggmap()` plot by adding `geom_***()` layers and specifying the data and mapping explicitly, but this approach has two big downsides: further layers also need to specify the data and mappings, and facetting won't work at all.

Luckily `ggmap()` provides a way around these downsides: the `base_layer` argument. You can pass `base_layer` a normal `ggplot()` call that specifies the default data and mappings for all layers.

For example, the initial plot:

```
ggmap(corvallis_map) +
  geom_point(data = sales, aes(lon, lat))
```

could have instead been:

```
ggmap(corvallis_map, 
    base_layer = ggplot(sales, aes(lon, lat))) +
  geom_point()
```

By moving `aes(x, y)` and data from the initial `geom_point()` function to the `ggplot()` call within the `ggmap()` call, you can add facets, or extra layers, the usual `ggplot2` way.

Let's try it out.

```{r}
# Use base_layer argument to ggmap() to specify data and x, y mappings
ggmap(corvallis_map_bw, base_layer = ggplot(sales, aes(lon, lat))) +
  geom_point(aes(color = year_built))

# Use base_layer argument to ggmap() and add facet_wrap()
ggmap(corvallis_map_bw, base_layer = ggplot(sales, aes(lon, lat))) +
  geom_point(aes(color = class)) +
  facet_wrap(~ class)
```

Using a base layer saves you from having repeated code when you have several geoms.

**A quick alternative**

`ggmap` also provides a quick alternative to `ggmap()`. Like `qplot()` in `ggplot2`, `qmplot()` is less flexible than a full specification, but often involves significantly less typing. `qmplot()` replaces both steps -- downloading the map and displaying the map -- and its syntax is a blend between `qplot()`, `get_map()`, and `ggmap()`.

Let's take a look at the `qmplot()` version of the faceted plot from the previous exercise:

```
qmplot(lon, lat, data = sales, 
       geom = "point", color = class) +
  facet_wrap(~ class)
```

Notice we didn't specify a map, since `qmplot()` will grab one on its own. Otherwise the `qmplot()` call looks a lot like the corresponding `qplot()` call: use points to display the sales data, mapping `lon` to the x-axis, `lat` to the y-axis, and `class` to color. `qmplot()` also sets the default dataset and mapping (without the need for `base_layer`) so you can add facets without any extra work.

```{r}
# Plot house sales using qmplot()
qmplot(lon, lat, data = sales, geom = "point", color = bedrooms) +
  facet_wrap(~ month)
```

**Common types of spatial data**